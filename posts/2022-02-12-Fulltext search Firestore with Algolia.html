<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2022-02-12">
<meta name="description" content="Installing Algolia as search engine for firebase">

<title>José Enrique Pons Website - Installing Algolia in Firebase</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-RQNWGYTYCC"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-RQNWGYTYCC', { 'anonymize_ip': true});
</script>


<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="José Enrique Pons Website - Installing Algolia in Firebase">
<meta property="og:description" content="Installing Algolia as search engine for firebase">
<meta property="og:image" content="https://politeles.github.io/politeles/posts/images/2022-02-12-firebase-collection.gif">
<meta property="og:site-name" content="José Enrique Pons Website">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">José Enrique Pons Website</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/politeles" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Installing Algolia in Firebase</h1>
                  <div>
        <div class="description">
          Installing Algolia as search engine for firebase
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">gcp</div>
                <div class="quarto-category">firebase</div>
                <div class="quarto-category">algolia</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 12, 2022</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#installing-algolia-as-a-search-engine-for-firebase" id="toc-installing-algolia-as-a-search-engine-for-firebase" class="nav-link active" data-scroll-target="#installing-algolia-as-a-search-engine-for-firebase">Installing Algolia as a search engine for firebase</a>
  <ul class="collapse">
  <li><a href="#query-limitations" id="toc-query-limitations" class="nav-link" data-scroll-target="#query-limitations">Query limitations</a></li>
  </ul></li>
  <li><a href="#algolia-to-the-rescue" id="toc-algolia-to-the-rescue" class="nav-link" data-scroll-target="#algolia-to-the-rescue">Algolia to the rescue</a>
  <ul class="collapse">
  <li><a href="#create-an-algolia-application-and-an-index-name." id="toc-create-an-algolia-application-and-an-index-name." class="nav-link" data-scroll-target="#create-an-algolia-application-and-an-index-name.">Create an Algolia application and an index name.</a></li>
  <li><a href="#obtain-the-api-key" id="toc-obtain-the-api-key" class="nav-link" data-scroll-target="#obtain-the-api-key">Obtain the API key</a></li>
  <li><a href="#add-algolia-extension-to-your-firebase-project" id="toc-add-algolia-extension-to-your-firebase-project" class="nav-link" data-scroll-target="#add-algolia-extension-to-your-firebase-project">Add Algolia extension to your firebase project</a></li>
  <li><a href="#installing-algolia-in-flutter-project" id="toc-installing-algolia-in-flutter-project" class="nav-link" data-scroll-target="#installing-algolia-in-flutter-project">Installing Algolia in Flutter project</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="installing-algolia-as-a-search-engine-for-firebase" class="level1">
<h1>Installing Algolia as a search engine for firebase</h1>
<p><a href="https://firebase.google.com/">Firebase</a> is a very popular service from Google. They provice authentication services, cloud databases, analytics for your apps, and there is a really cool integration with Dart/Flutter.</p>
<p>We are using a <a href="https://firebase.google.com/docs/firestore/">document database called Firestore</a>.</p>
<p>It’s a cool document database, with some similar concepts to <a href="https://www.mongodb.com">MongoDB</a>, in the sense it groups the elements o the database in documents and collections. What’s different is the grouping of these elements.</p>
<p>First, you define a collection which contains documents. Each document may, at the same time contain attributes and collections.</p>
<p>For instance, my <em>user</em> collection contains a set of documents representing each a user. To register the attendance, each user contains a collection with its own attendances (instead of having an <em>attendance</em> collection and somehow linking the collection to the user).</p>
<p><img src="images/2022-02-12-firebase-collection.gif" class="img-fluid"></p>
<p>In the image, you see, that the user collection, contains documents with the info of each user. The so-called attributes like the user name, email, and so on. But at the user level, that’s at the level of the attributes, you can define collections, in this case a collection for the attendance with a set of attributes.</p>
<p>The problem with this way of organizing the information, compared to the typical canonical, relational table shape, is the way to query the information.</p>
<p>How to query? <a href="https://firebase.google.com/docs/firestore/query-data/queries">The search functionality provided with Firestore is quite limited.</a>.</p>
<p>The set of limitations as described in the previous link are the following:</p>
<section id="query-limitations" class="level2">
<h2 class="anchored" data-anchor-id="query-limitations">Query limitations</h2>
<p>The following list summarizes Cloud Firestore query limitations:</p>
<pre><code>- Cloud Firestore provides limited support for logical OR queries. The in, and array-contains-any operators support a logical OR of up to 10 equality (==) or array-contains conditions on a single field. For other cases, create a separate query for each OR condition and merge the query results in your app.
- In a compound query, range (&lt;, &lt;=, &gt;, &gt;=) and not equals (!=, not-in) comparisons must all filter on the same field.
- You can use at most one array-contains clause per query. You can't combine array-contains with array-contains-any.
- You can use at most one in, not-in, or array-contains-any clause per query. You can't combine in , not-in, and array-contains-any in the same query.
- You can't order your query by a field included in an equality (==) or in clause.
- The sum of filters, sort orders, and parent document path (1 for a subcollection, 0 for a root collection) in a query cannot exceed 100.</code></pre>
</section>
</section>
<section id="algolia-to-the-rescue" class="level1">
<h1>Algolia to the rescue</h1>
<p>One of the limitations is full text search for a given attribute. That is, we can’t search for all users starting with <em>Jos</em>.</p>
<p>We can configure Algolia community edition with our Firebase project to run queries like this. The process is as follows: - First, register in Algolia and create a free account. - Create an Algolia application and an index name. - Next, <a href="https://firebase.google.com/products/extensions/algolia-firestore-algolia-search">add the Algolia extension to your project.</a> - After the extension is installed, you will find a cloud function that is triggered every document update. But, if your Firestore database has already some data, you have to create another cloud function (that will be triggered maybe just once) to send all your initial data to Algolia index. <a href="https://rsfarias.medium.com/how-to-set-up-firestore-and-algolia-319fcf2c0d37">Some tips for that cloud functions are here</a></p>
<section id="create-an-algolia-application-and-an-index-name." class="level2">
<h2 class="anchored" data-anchor-id="create-an-algolia-application-and-an-index-name.">Create an Algolia application and an index name.</h2>
<p><img src="images/2022-02-12-algolia-index-creation.gif" class="img-fluid"></p>
</section>
<section id="obtain-the-api-key" class="level2">
<h2 class="anchored" data-anchor-id="obtain-the-api-key">Obtain the API key</h2>
<p><img src="images/2022-02-12-algolia-api-key.gif" class="img-fluid"></p>
</section>
<section id="add-algolia-extension-to-your-firebase-project" class="level2">
<h2 class="anchored" data-anchor-id="add-algolia-extension-to-your-firebase-project">Add Algolia extension to your firebase project</h2>
<p><img src="images/2022-02-12-algolia-extension.gif" class="img-fluid"></p>
<p><img src="images/2022-02-12-algolia-extension-install.gif" class="img-fluid"></p>
<p>Export all records: https://discourse.algolia.com/t/export-all-records-from-firestore-to-indices-with-google-cloud-function/10358/3</p>
<p>Implementation in flutter https://www.algolia.com/doc/guides/building-search-ui/getting-started/how-to/flutter/ios/</p>
<p>Some references:</p>
<p>https://www.algolia.com/doc/api-reference/api-methods/save-objects/#examples</p>
<p>https://www.algolia.com/doc/api-client/getting-started/install/javascript/?client=javascript</p>
<p>Code to generate the index for the first time:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode dart code-with-copy"><code class="sourceCode dart"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>exports<span class="op">.</span>index_all_sheets <span class="op">=</span> functions<span class="op">.</span>runWith({</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  allowInvalidAppCheckToken<span class="op">:</span> <span class="cn">false</span><span class="op">,</span> <span class="co">// Opt-out: Requests with invalid App</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Check tokens continue to your code.</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>})<span class="op">.</span>https<span class="op">.</span>onCall((data<span class="op">,</span> context) <span class="op">=&gt;</span> {</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> algolia <span class="op">=</span> algoliasearch(<span class="st">"projectID"</span><span class="op">,</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">"secret"</span>);</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> index <span class="op">=</span> algolia<span class="op">.</span>initIndex(<span class="st">"sheetIndex"</span>);</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  functions<span class="op">.</span>logger<span class="op">.</span>info(<span class="st">'indexing all sheets'</span>);</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  let records <span class="op">=</span> [];</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  admin<span class="op">.</span>firestore()<span class="op">.</span>collection(<span class="st">"partitura"</span>)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="kw">get</span>()<span class="op">.</span>then((docs)<span class="op">=&gt;</span> {</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        docs<span class="op">.</span>forEach((doc)<span class="op">=&gt;</span>{</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>          <span class="at">const</span> obj <span class="op">=</span> doc<span class="op">.</span>data();</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>          obj<span class="op">.</span>objectID <span class="op">=</span> doc<span class="op">.</span>id;</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>          obj<span class="op">.</span>path <span class="op">=</span> <span class="st">'partitura/'</span><span class="op">+</span>doc<span class="op">.</span>id;</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>          obj<span class="op">.</span>compositor <span class="op">=</span> doc<span class="op">.</span>compositor;</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>          obj<span class="op">.</span>compositor <span class="op">=</span> doc<span class="op">.</span>obra;</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>          records<span class="op">.</span>push(obj);</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>          functions<span class="op">.</span>logger<span class="op">.</span>info(<span class="st">'indexing doc'</span>);</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>        });</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>        functions<span class="op">.</span>logger<span class="op">.</span>info(<span class="st">'fetch completed'</span>);</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>        index<span class="op">.</span>saveObjects(records)<span class="op">.</span>then(({objectIDs})<span class="op">=&gt;</span>{</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>          functions<span class="op">.</span>logger<span class="op">.</span>info(<span class="st">"indexing completed"</span><span class="op">,</span> objectIDs);</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>        });</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>      });</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> <span class="cn">true</span>;</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>});</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="installing-algolia-in-flutter-project" class="level2">
<h2 class="anchored" data-anchor-id="installing-algolia-in-flutter-project">Installing Algolia in Flutter project</h2>
<p>The first step is to <a href="https://www.algolia.com/doc/guides/building-search-ui/getting-started/how-to/flutter/ios/">add the Algolia library in your flutter project.</a> <a href="https://pub.dev/packages/algolia/install">You can do so installing the package.</a></p>
<pre class="shell"><code>flutter pub add algolia</code></pre>
<p>There are other options, but this one is the fastest for me. Next, I’m going to create an algolia_options.dart file to store the api key (in the same fashion as the Firebase Options).</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode dart code-with-copy"><code class="sourceCode dart"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="st">'package:algolia/algolia.dart'</span>;</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AlgoliaOptions {</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// The API key that is used to identify an instance of algolia</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">String</span> apiKey;</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">/// The application Id in Algolia</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">String</span> applicationId;</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> AlgoliaOptions({required <span class="kw">this</span><span class="op">.</span>apiKey<span class="op">,</span> required <span class="kw">this</span><span class="op">.</span>applicationId});</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">static</span> <span class="at">const</span> AlgoliaOptions algoliaOptions <span class="op">=</span> AlgoliaOptions(</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>      apiKey<span class="op">:</span> <span class="st">"xxxxxxxx2"</span><span class="op">,</span> applicationId<span class="op">:</span> <span class="st">"AAAAAAAAAB"</span>);</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>the values of the api key and appId can be found in your <a href="https://www.algolia.com/account/api-keys/">Algolia settings page.</a></p>
<p>Now, I’m going to write the code to search using the algolia index created in the previous steps. First, in the state class I create a private attribute called _algoliaClient</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode dart code-with-copy"><code class="sourceCode dart"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> _PartituraScreenState <span class="kw">extends</span> State<span class="op">&lt;</span>PartituraScreen<span class="op">&gt;</span> {</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> Algolia _algoliaClient <span class="op">=</span> Algolia<span class="op">.</span>init(</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>      applicationId<span class="op">:</span> AlgoliaOptions<span class="op">.</span>algoliaOptions<span class="op">.</span>applicationId<span class="op">,</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>      apiKey<span class="op">:</span> AlgoliaOptions<span class="op">.</span>algoliaOptions<span class="op">.</span>apiKey);</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>      TextEditingController _textFieldController <span class="op">=</span> TextEditingController();</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I’m adding a text controller for the filter. I’m also creating a proxy class for the Sheet class:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode dart code-with-copy"><code class="sourceCode dart"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SheetProxy {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">String</span> id;</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">String</span> obra;</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">final</span> <span class="dt">String</span> compositor;</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  SheetProxy({required <span class="kw">this</span><span class="op">.</span>id<span class="op">,</span> required <span class="kw">this</span><span class="op">.</span>obra<span class="op">,</span> required <span class="kw">this</span><span class="op">.</span>compositor});</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">static</span> SheetProxy fromJson(<span class="dt">Map</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">,</span> <span class="at">dynamic</span><span class="op">&gt;</span> json) {</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">final</span> <span class="dt">String</span> id <span class="op">=</span> json[<span class="st">'path'</span>]<span class="op">.</span>toString()<span class="op">.</span>split(<span class="st">"/"</span>)[<span class="dv">1</span>];</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> SheetProxy(</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        id<span class="op">:</span> id<span class="op">,</span> obra<span class="op">:</span> json[<span class="st">'obra'</span>]<span class="op">,</span> compositor<span class="op">:</span> json[<span class="st">'compositor'</span>]);</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The function to search the elements is the following, that maps the content to the SheetProxy instance.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode dart code-with-copy"><code class="sourceCode dart"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="dt">Future</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> _getSearchResult(<span class="dt">String</span> query) <span class="at">async</span> {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    AlgoliaQuery algoliaQuery <span class="op">=</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>        _algoliaClient<span class="op">.</span>instance<span class="op">.</span>index(<span class="st">"sheetIndex"</span>)<span class="op">.</span>query(query);</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    AlgoliaQuerySnapshot snapshot <span class="op">=</span> <span class="at">await</span> algoliaQuery<span class="op">.</span>getObjects();</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">final</span> rawHits <span class="op">=</span> snapshot<span class="op">.</span>toMap()[<span class="st">'hits'</span>] <span class="kw">as</span> <span class="dt">List</span>;</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">final</span> hits <span class="op">=</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">List</span><span class="op">&lt;</span>SheetProxy<span class="op">&gt;.</span>from(rawHits<span class="op">.</span>map((hit) <span class="op">=&gt;</span> SheetProxy<span class="op">.</span>fromJson(hit)));</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    setState(() {</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>      _sheets <span class="op">=</span> hits;</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    });</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    print(rawHits);</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Finally, on the init state, we add a listener to the text field controller:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode dart code-with-copy"><code class="sourceCode dart"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">@override</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> initState() {</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span><span class="op">.</span>initState();</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    _textFieldController<span class="op">.</span>addListener(() {</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (_query <span class="op">!=</span> _textFieldController<span class="op">.</span>text) {</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>        setState(() {</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>          _query <span class="op">=</span> _textFieldController<span class="op">.</span>text;</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        });</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        _getSearchResult(_query);</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    });</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    _getSearchResult(<span class="st">''</span>);</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The application with the filtering looks like this:</p>
<p><img src="images/2022-02-12-app.gif" class="img-fluid"></p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>