<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Installing Algolia in Firebase</h1><p class="page-description">Installing Algolia as search engine for firebase</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-02-12T00:00:00-06:00" itemprop="datePublished">
        Feb 12, 2022
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      5 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#gcp firebase algolia">gcp firebase algolia</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h1"><a href="#installing-algolia-as-a-search-engine-for-firebase">Installing Algolia as a search engine for firebase</a>
<ul>
<li class="toc-entry toc-h2"><a href="#query-limitations">Query limitations</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#algolia-to-the-rescue">Algolia to the rescue</a>
<ul>
<li class="toc-entry toc-h2"><a href="#create-an-algolia-application-and-an-index-name">Create an Algolia application and an index name.</a></li>
<li class="toc-entry toc-h2"><a href="#obtain-the-api-key">Obtain the API key</a></li>
<li class="toc-entry toc-h2"><a href="#add-algolia-extension-to-your-firebase-project">Add Algolia extension to your firebase project</a></li>
<li class="toc-entry toc-h2"><a href="#installing-algolia-in-flutter-project">Installing Algolia in Flutter project</a></li>
</ul>
</li>
</ul><h1 id="installing-algolia-as-a-search-engine-for-firebase">
<a class="anchor" href="#installing-algolia-as-a-search-engine-for-firebase" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installing Algolia as a search engine for firebase</h1>

<p><a href="https://firebase.google.com/">Firebase</a> is a very popular service from Google. They provice authentication services, cloud databases, analytics for your apps, and there is a really cool integration with Dart/Flutter.</p>

<p>We are using a <a href="https://firebase.google.com/docs/firestore/">document database called Firestore</a>.</p>

<p>It’s a cool document database, with some similar concepts to <a href="https://www.mongodb.com">MongoDB</a>, in the sense it groups the elements o the database in documents and collections. What’s different is the grouping of these elements.</p>

<p>First, you define a collection which contains documents. Each document may, at the same time contain attributes and collections.</p>

<p>For instance, my <em>user</em> collection contains a set of documents representing each a user. To register the attendance, each user contains a collection with its own attendances (instead of having an <em>attendance</em> collection and somehow linking the collection to the user).</p>

<p><img src="/images/2022-02-12-firebase-collection.gif" alt=""></p>

<p>In the image, you see, that the user collection, contains documents with the info of each user. The so-called attributes like the user name, email, and so on. But at the user level, that’s at the level of the attributes, you can define collections, in this case a collection for the attendance with a set of attributes.</p>

<p>The problem with this way of organizing the information, compared to the typical canonical, relational table shape, is the way to query the information.</p>

<p>How to query? <a href="https://firebase.google.com/docs/firestore/query-data/queries">The search functionality provided with Firestore is quite limited.</a>.</p>

<p>The set of limitations as described in the previous link are the following:</p>

<h2 id="query-limitations">
<a class="anchor" href="#query-limitations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Query limitations</h2>

<p>The following list summarizes Cloud Firestore query limitations:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Cloud Firestore provides limited support for logical OR queries. The in, and array-contains-any operators support a logical OR of up to 10 equality (==) or array-contains conditions on a single field. For other cases, create a separate query for each OR condition and merge the query results in your app.
- In a compound query, range (&lt;, &lt;=, &gt;, &gt;=) and not equals (!=, not-in) comparisons must all filter on the same field.
- You can use at most one array-contains clause per query. You can't combine array-contains with array-contains-any.
- You can use at most one in, not-in, or array-contains-any clause per query. You can't combine in , not-in, and array-contains-any in the same query.
- You can't order your query by a field included in an equality (==) or in clause.
- The sum of filters, sort orders, and parent document path (1 for a subcollection, 0 for a root collection) in a query cannot exceed 100.
</code></pre></div></div>

<h1 id="algolia-to-the-rescue">
<a class="anchor" href="#algolia-to-the-rescue" aria-hidden="true"><span class="octicon octicon-link"></span></a>Algolia to the rescue</h1>

<p>One of the limitations is full text search for a given attribute. That is, we can’t search for all users starting with <em>Jos</em>.</p>

<p>We can configure Algolia community edition with our Firebase project to run queries like this.
The process is as follows:</p>
<ul>
  <li>First, register in Algolia and create a free account.</li>
  <li>Create an Algolia application and an index name.</li>
  <li>Next, <a href="https://firebase.google.com/products/extensions/algolia-firestore-algolia-search">add the Algolia extension to your project. </a>
</li>
  <li>After the extension is installed, you will find a cloud function that is triggered every document update. But, if your Firestore database has already some data, you have to create another cloud function (that will be triggered maybe just once) to send all your initial data to Algolia index. <a href="https://rsfarias.medium.com/how-to-set-up-firestore-and-algolia-319fcf2c0d37">Some tips for that cloud functions are here</a>
</li>
</ul>

<h2 id="create-an-algolia-application-and-an-index-name">
<a class="anchor" href="#create-an-algolia-application-and-an-index-name" aria-hidden="true"><span class="octicon octicon-link"></span></a>Create an Algolia application and an index name.</h2>

<p><img src="/images/2022-02-12-algolia-index-creation.gif" alt=""></p>

<h2 id="obtain-the-api-key">
<a class="anchor" href="#obtain-the-api-key" aria-hidden="true"><span class="octicon octicon-link"></span></a>Obtain the API key</h2>
<p><img src="/images/2022-02-12-algolia-api-key.gif" alt=""></p>

<h2 id="add-algolia-extension-to-your-firebase-project">
<a class="anchor" href="#add-algolia-extension-to-your-firebase-project" aria-hidden="true"><span class="octicon octicon-link"></span></a>Add Algolia extension to your firebase project</h2>

<p><img src="/images/2022-02-12-algolia-extension.gif" alt=""></p>

<p><img src="/images/2022-02-12-algolia-extension-install.gif" alt=""></p>

<p>Export all records:
https://discourse.algolia.com/t/export-all-records-from-firestore-to-indices-with-google-cloud-function/10358/3</p>

<p>Implementation in flutter https://www.algolia.com/doc/guides/building-search-ui/getting-started/how-to/flutter/ios/</p>

<p>Some references:</p>

<p>https://www.algolia.com/doc/api-reference/api-methods/save-objects/#examples</p>

<p>https://www.algolia.com/doc/api-client/getting-started/install/javascript/?client=javascript</p>

<p>Code to generate the index for the first time:</p>
<div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">exports</span><span class="o">.</span><span class="na">index_all_sheets</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="na">runWith</span><span class="p">({</span>
  <span class="nl">allowInvalidAppCheckToken:</span> <span class="kc">false</span><span class="p">,</span> <span class="c1">// Opt-out: Requests with invalid App</span>
  <span class="c1">// Check tokens continue to your code.</span>
<span class="p">})</span><span class="o">.</span><span class="na">https</span><span class="o">.</span><span class="na">onCall</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span> <span class="o">=</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="n">algolia</span> <span class="o">=</span> <span class="n">algoliasearch</span><span class="p">(</span><span class="s">"projectID"</span><span class="p">,</span>
      <span class="s">"secret"</span><span class="p">);</span>
  <span class="kd">const</span> <span class="n">index</span> <span class="o">=</span> <span class="n">algolia</span><span class="o">.</span><span class="na">initIndex</span><span class="p">(</span><span class="s">"sheetIndex"</span><span class="p">);</span>

  <span class="n">functions</span><span class="o">.</span><span class="na">logger</span><span class="o">.</span><span class="na">info</span><span class="p">(</span><span class="s">'indexing all sheets'</span><span class="p">);</span>
  <span class="n">let</span> <span class="n">records</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="n">admin</span><span class="o">.</span><span class="na">firestore</span><span class="p">()</span><span class="o">.</span><span class="na">collection</span><span class="p">(</span><span class="s">"partitura"</span><span class="p">)</span>
      <span class="o">.</span><span class="na">get</span><span class="p">()</span><span class="o">.</span><span class="na">then</span><span class="p">((</span><span class="n">docs</span><span class="p">)</span><span class="o">=</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="n">docs</span><span class="o">.</span><span class="na">forEach</span><span class="p">((</span><span class="n">doc</span><span class="p">)</span><span class="o">=</span><span class="p">&gt;{</span>
          <span class="kd">const</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="na">data</span><span class="p">();</span>
          <span class="n">obj</span><span class="o">.</span><span class="na">objectID</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="na">id</span><span class="p">;</span>
          <span class="n">obj</span><span class="o">.</span><span class="na">path</span> <span class="o">=</span> <span class="s">'partitura/'</span><span class="o">+</span><span class="n">doc</span><span class="o">.</span><span class="na">id</span><span class="p">;</span>
          <span class="n">obj</span><span class="o">.</span><span class="na">compositor</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="na">compositor</span><span class="p">;</span>
          <span class="n">obj</span><span class="o">.</span><span class="na">compositor</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="na">obra</span><span class="p">;</span>
          <span class="n">records</span><span class="o">.</span><span class="na">push</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
          <span class="n">functions</span><span class="o">.</span><span class="na">logger</span><span class="o">.</span><span class="na">info</span><span class="p">(</span><span class="s">'indexing doc'</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="n">functions</span><span class="o">.</span><span class="na">logger</span><span class="o">.</span><span class="na">info</span><span class="p">(</span><span class="s">'fetch completed'</span><span class="p">);</span>
        <span class="n">index</span><span class="o">.</span><span class="na">saveObjects</span><span class="p">(</span><span class="n">records</span><span class="p">)</span><span class="o">.</span><span class="na">then</span><span class="p">(({</span><span class="n">objectIDs</span><span class="p">})</span><span class="o">=</span><span class="p">&gt;{</span>
          <span class="n">functions</span><span class="o">.</span><span class="na">logger</span><span class="o">.</span><span class="na">info</span><span class="p">(</span><span class="s">"indexing completed"</span><span class="p">,</span> <span class="n">objectIDs</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">});</span>
  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">});</span>

</code></pre></div></div>

<h2 id="installing-algolia-in-flutter-project">
<a class="anchor" href="#installing-algolia-in-flutter-project" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installing Algolia in Flutter project</h2>

<p>The first step is to <a href="https://www.algolia.com/doc/guides/building-search-ui/getting-started/how-to/flutter/ios/">add the Algolia library in your flutter project.</a> <a href="https://pub.dev/packages/algolia/install">You can do so installing the package.</a></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>flutter pub add algolia
</code></pre></div></div>

<p>There are other options, but this one is the fastest for me.
Next, I’m going to create an algolia_options.dart file to store the api key (in the same fashion as the Firebase Options).</p>

<div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="s">'package:algolia/algolia.dart'</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">AlgoliaOptions</span> <span class="p">{</span>
  <span class="c1">/// The API key that is used to identify an instance of algolia</span>
  <span class="kd">final</span> <span class="kt">String</span> <span class="n">apiKey</span><span class="p">;</span>

  <span class="c1">/// The application Id in Algolia</span>
  <span class="kd">final</span> <span class="kt">String</span> <span class="n">applicationId</span><span class="p">;</span>

  <span class="kd">const</span> <span class="n">AlgoliaOptions</span><span class="p">({</span><span class="kd">required</span> <span class="k">this</span><span class="o">.</span><span class="na">apiKey</span><span class="p">,</span> <span class="kd">required</span> <span class="k">this</span><span class="o">.</span><span class="na">applicationId</span><span class="p">});</span>

  <span class="kd">static</span> <span class="kd">const</span> <span class="n">AlgoliaOptions</span> <span class="n">algoliaOptions</span> <span class="o">=</span> <span class="n">AlgoliaOptions</span><span class="p">(</span>
      <span class="nl">apiKey:</span> <span class="s">"xxxxxxxx2"</span><span class="p">,</span> <span class="nl">applicationId:</span> <span class="s">"AAAAAAAAAB"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>the values of the api key and appId can be found in your <a href="https://www.algolia.com/account/api-keys/">Algolia settings page.</a></p>

<p>Now, I’m going to write the code to search using the algolia index created in the previous steps.
First, in the state class I create a private attribute called _algoliaClient</p>

<div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">_PartituraScreenState</span> <span class="kd">extends</span> <span class="n">State</span><span class="p">&lt;</span><span class="n">PartituraScreen</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="kd">final</span> <span class="n">Algolia</span> <span class="n">_algoliaClient</span> <span class="o">=</span> <span class="n">Algolia</span><span class="o">.</span><span class="na">init</span><span class="p">(</span>
      <span class="nl">applicationId:</span> <span class="n">AlgoliaOptions</span><span class="o">.</span><span class="na">algoliaOptions</span><span class="o">.</span><span class="na">applicationId</span><span class="p">,</span>
      <span class="nl">apiKey:</span> <span class="n">AlgoliaOptions</span><span class="o">.</span><span class="na">algoliaOptions</span><span class="o">.</span><span class="na">apiKey</span><span class="p">);</span>
	  <span class="n">TextEditingController</span> <span class="n">_textFieldController</span> <span class="o">=</span> <span class="n">TextEditingController</span><span class="p">();</span>

</code></pre></div></div>

<p>I’m adding a text controller for the filter. I’m also creating a proxy class for the Sheet class:</p>
<div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">SheetProxy</span> <span class="p">{</span>
  <span class="kd">final</span> <span class="kt">String</span> <span class="n">id</span><span class="p">;</span>
  <span class="kd">final</span> <span class="kt">String</span> <span class="n">obra</span><span class="p">;</span>
  <span class="kd">final</span> <span class="kt">String</span> <span class="n">compositor</span><span class="p">;</span>

  <span class="n">SheetProxy</span><span class="p">({</span><span class="kd">required</span> <span class="k">this</span><span class="o">.</span><span class="na">id</span><span class="p">,</span> <span class="kd">required</span> <span class="k">this</span><span class="o">.</span><span class="na">obra</span><span class="p">,</span> <span class="kd">required</span> <span class="k">this</span><span class="o">.</span><span class="na">compositor</span><span class="p">});</span>

  <span class="kd">static</span> <span class="n">SheetProxy</span> <span class="n">fromJson</span><span class="p">(</span><span class="kt">Map</span><span class="p">&lt;</span><span class="kt">String</span><span class="p">,</span> <span class="kd">dynamic</span><span class="p">&gt;</span> <span class="n">json</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">final</span> <span class="kt">String</span> <span class="n">id</span> <span class="o">=</span> <span class="n">json</span><span class="p">[</span><span class="s">'path'</span><span class="p">]</span><span class="o">.</span><span class="na">toString</span><span class="p">()</span><span class="o">.</span><span class="na">split</span><span class="p">(</span><span class="s">"/"</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">return</span> <span class="n">SheetProxy</span><span class="p">(</span>
        <span class="nl">id:</span> <span class="n">id</span><span class="p">,</span> <span class="nl">obra:</span> <span class="n">json</span><span class="p">[</span><span class="s">'obra'</span><span class="p">],</span> <span class="nl">compositor:</span> <span class="n">json</span><span class="p">[</span><span class="s">'compositor'</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The function to search the elements is the following, that maps the content to the SheetProxy instance.</p>

<div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Future</span><span class="p">&lt;</span><span class="kt">void</span><span class="p">&gt;</span> <span class="n">_getSearchResult</span><span class="p">(</span><span class="kt">String</span> <span class="n">query</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
    <span class="n">AlgoliaQuery</span> <span class="n">algoliaQuery</span> <span class="o">=</span>
        <span class="n">_algoliaClient</span><span class="o">.</span><span class="na">instance</span><span class="o">.</span><span class="na">index</span><span class="p">(</span><span class="s">"sheetIndex"</span><span class="p">)</span><span class="o">.</span><span class="na">query</span><span class="p">(</span><span class="n">query</span><span class="p">);</span>
    <span class="n">AlgoliaQuerySnapshot</span> <span class="n">snapshot</span> <span class="o">=</span> <span class="k">await</span> <span class="n">algoliaQuery</span><span class="o">.</span><span class="na">getObjects</span><span class="p">();</span>
    <span class="kd">final</span> <span class="n">rawHits</span> <span class="o">=</span> <span class="n">snapshot</span><span class="o">.</span><span class="na">toMap</span><span class="p">()[</span><span class="s">'hits'</span><span class="p">]</span> <span class="k">as</span> <span class="kt">List</span><span class="p">;</span>
    <span class="kd">final</span> <span class="n">hits</span> <span class="o">=</span>
        <span class="kt">List</span><span class="p">&lt;</span><span class="n">SheetProxy</span><span class="p">&gt;</span><span class="o">.</span><span class="na">from</span><span class="p">(</span><span class="n">rawHits</span><span class="o">.</span><span class="na">map</span><span class="p">((</span><span class="n">hit</span><span class="p">)</span> <span class="o">=</span><span class="p">&gt;</span> <span class="n">SheetProxy</span><span class="o">.</span><span class="na">fromJson</span><span class="p">(</span><span class="n">hit</span><span class="p">)));</span>

    <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span>
      <span class="n">_sheets</span> <span class="o">=</span> <span class="n">hits</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="n">print</span><span class="p">(</span><span class="n">rawHits</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>Finally, on the init state, we add a listener to the text field controller:</p>

<div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@override</span>
  <span class="kt">void</span> <span class="n">initState</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">super</span><span class="o">.</span><span class="na">initState</span><span class="p">();</span>
    <span class="n">_textFieldController</span><span class="o">.</span><span class="na">addListener</span><span class="p">(()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">_query</span> <span class="o">!=</span> <span class="n">_textFieldController</span><span class="o">.</span><span class="na">text</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">setState</span><span class="p">(()</span> <span class="p">{</span>
          <span class="n">_query</span> <span class="o">=</span> <span class="n">_textFieldController</span><span class="o">.</span><span class="na">text</span><span class="p">;</span>
        <span class="p">});</span>
        <span class="n">_getSearchResult</span><span class="p">(</span><span class="n">_query</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
    <span class="n">_getSearchResult</span><span class="p">(</span><span class="s">''</span><span class="p">);</span>
  <span class="p">}</span>

</code></pre></div></div>

<p>The application with the filtering looks like this:</p>

<p><img src="/images/2022-02-12-app.gif" alt=""></p>


  </div><a class="u-url" href="/2022/02/12/Fulltext-search-Firestore-with-Algolia" hidden></a>
</article>
