<h1 id="setting-up-elk-stack-on-kubernetes-in-docker-for-windows">Setting up ELK stack on Kubernetes in docker for windows.</h1>

<p>First of all, I’m installing <a href="https://github.com/helm/helm/releases">Helm</a> from the releases page, the windows version. I copied to the typical windows program files folder and updated the PATH environment variable to check the new helm folder. So now I can use it in console.
I studied the following tutorials: 
(https://blog.knoldus.com/how-to-deploy-elk-stack-on-kubernetes/
https://tharangarajapaksha.medium.com/)(elk-stack-in-k8s-cluster-13bb509185e0)
(https://www.cloudsigma.com/installing-software-on-kubernetes-with-helm-3-package-manager-on-windows/)</p>

<p>I’m going to <a href="https://kubernetes.io/docs/tasks/administer-cluster/namespaces/">create a new namespace in the k8s cluster</a> for elk stak.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kubectl</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nx">namespace</span><span class="w"> </span><span class="nx">elk</span><span class="w"> 
</span></code></pre></div></div>

<p>Because I have Helm, I’m going to <a href="https://kubernetes.github.io/ingress-nginx/deploy/#quick-start">install the ingress controller</a> using the following command:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">helm</span><span class="w"> </span><span class="nx">upgrade</span><span class="w"> </span><span class="nt">--install</span><span class="w"> </span><span class="nx">ingress-nginx</span><span class="w"> </span><span class="nx">ingress-nginx</span><span class="w">   </span><span class="nt">--repo</span><span class="w"> </span><span class="nx">https://kubernetes.github.io/ingress-nginx</span><span class="w">   </span><span class="nt">--namespace</span><span class="w"> </span><span class="nx">ingress-nginx</span><span class="w"> </span><span class="nt">--create-namespace</span><span class="w">
</span></code></pre></div></div>

<p>Now I’m going to install the helm chart for elasticsearch, I’m using the default values, but I’m going to change the name of the release to elk.</p>

<p>I’m using the guide from elastic.co <a href="https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-deploy-eck.html">here</a></p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kubectl</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="nx">https://download.elastic.co/downloads/eck/2.8.0/crds.yaml</span><span class="w">
</span></code></pre></div></div>

<p>Now, I’m going to install the operator, which is the one that will create the elasticsearch cluster.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kubectl</span><span class="w"> </span><span class="nx">apply</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="nx">https://download.elastic.co/downloads/eck/2.8.0/operator.yaml</span><span class="w">
</span></code></pre></div></div>

<p>Monitor the operator deployment until it is ready:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kubectl</span><span class="w"> </span><span class="nt">-n</span><span class="w"> </span><span class="nx">elastic-system</span><span class="w"> </span><span class="nx">logs</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="nx">statefulset.apps/elastic-operator</span><span class="w">
</span></code></pre></div></div>

<p>Now, I’m going to apply the operator configuration, which is the one that will create the elasticsearch cluster.</p>

<p>Create a file with the following content:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">elasticsearch.k8s.elastic.co/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Elasticsearch</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">quickstart</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s">8.8.2</span>
  <span class="na">nodeSets</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">default</span>
    <span class="na">count</span><span class="pi">:</span> <span class="m">1</span>
    <span class="na">config</span><span class="pi">:</span>
      <span class="na">node.store.allow_mmap</span><span class="pi">:</span> <span class="no">false</span>
</code></pre></div></div>

<p>and now apply it:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kubectl</span><span class="w"> </span><span class="nx">apply</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="nx">elasticsearch.yaml</span><span class="w">
</span></code></pre></div></div>

<p>It will take a while to be available, you can check the status with the following command:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kubectl</span><span class="w"> </span><span class="nx">get</span><span class="w"> </span><span class="nx">elasticsearch</span><span class="w">
</span></code></pre></div></div>

<p>and the output:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">NAME</span><span class="w">         </span><span class="nx">HEALTH</span><span class="w">    </span><span class="nx">NODES</span><span class="w">   </span><span class="nx">VERSION</span><span class="w">   </span><span class="nx">PHASE</span><span class="w">             </span><span class="nx">AGE</span><span class="w">
</span><span class="n">quickstart</span><span class="w">   </span><span class="nx">unknown</span><span class="w">           </span><span class="nx">8.8.2</span><span class="w">     </span><span class="nx">ApplyingChanges</span><span class="w">   </span><span class="nx">46s</span><span class="w">
</span></code></pre></div></div>

<p>when it’s ready, the output will be:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">NAME</span><span class="w">         </span><span class="nx">HEALTH</span><span class="w">   </span><span class="nx">NODES</span><span class="w">   </span><span class="nx">VERSION</span><span class="w">   </span><span class="nx">PHASE</span><span class="w">   </span><span class="nx">AGE</span><span class="w">
</span><span class="n">quickstart</span><span class="w">   </span><span class="nx">green</span><span class="w">    </span><span class="nx">1</span><span class="w">       </span><span class="nx">8.8.2</span><span class="w">     </span><span class="nx">Ready</span><span class="w">   </span><span class="nx">2m38s</span><span class="w">
</span></code></pre></div></div>

<p>You can check the pods with the following command:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kubectl</span><span class="w"> </span><span class="nx">get</span><span class="w"> </span><span class="nx">pods</span><span class="w"> </span><span class="nt">--selector</span><span class="o">=</span><span class="s1">'elasticsearch.k8s.elastic.co/cluster-name=quickstart'</span><span class="w">
</span></code></pre></div></div>

<h2 id="request-elasticsearch-access">Request Elasticsearch access</h2>
<p>first, check the cluster IP:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kubectl</span><span class="w"> </span><span class="nx">get</span><span class="w"> </span><span class="nx">service</span><span class="w"> </span><span class="nx">quickstart-es-http</span><span class="w">
</span></code></pre></div></div>

<p>Next, get the credentials (you can use powershell)</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$PASSWORD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kubectl</span><span class="w"> </span><span class="nx">get</span><span class="w"> </span><span class="nx">secret</span><span class="w"> </span><span class="nx">quickstart-es-elastic-user</span><span class="w"> </span><span class="nt">-o</span><span class="w"> </span><span class="nx">go-template</span><span class="o">=</span><span class="s1">''</span><span class="w">
</span></code></pre></div></div>

<p>or you can use cmd:</p>
<pre><code class="language-cmd">curl -u "elastic:$PASSWORD" -k "https://localhost:9200"
{
  "name" : "quickstart-es-default-0",
  "cluster_name" : "quickstart",
  "cluster_uuid" : "WWtwSzimREaMT38n65lghA",
  "version" : {
    "number" : "8.8.2",
    "build_flavor" : "default",
    "build_type" : "docker",
    "build_hash" : "98e1271edf932a480e4262a471281f1ee295ce6b",
    "build_date" : "2023-06-26T05:16:16.196344851Z",
    "build_snapshot" : false,
    "lucene_version" : "9.6.0",
    "minimum_wire_compatibility_version" : "7.17.0",
    "minimum_index_compatibility_version" : "7.0.0"
  },
  "tagline" : "You Know, for Search"
}
</code></pre>

<h2 id="kibana">Kibana</h2>
<p>To deploy Kibana, we use the following file:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">kibana.k8s.elastic.co/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Kibana</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">quickstart</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s">8.8.2</span>
  <span class="na">count</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">elasticsearchRef</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">quickstart</span>
</code></pre></div></div>

<p>The command to apply it is:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kubectl</span><span class="w"> </span><span class="nx">apply</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="o">.</span><span class="nx">\kibana.yaml</span><span class="w">
</span></code></pre></div></div>

<p>Check the status and wait until it’s ready:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kubectl</span><span class="w"> </span><span class="nx">get</span><span class="w"> </span><span class="nx">kibana</span><span class="w">
</span></code></pre></div></div>

<p>The output will be:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">NAME</span><span class="w">         </span><span class="nx">HEALTH</span><span class="w">   </span><span class="nx">NODES</span><span class="w">   </span><span class="nx">VERSION</span><span class="w">   </span><span class="nx">AGE</span><span class="w">
</span><span class="n">quickstart</span><span class="w">   </span><span class="nx">red</span><span class="w">              </span><span class="nx">8.8.2</span><span class="w">     </span><span class="nx">38s</span><span class="w">
</span></code></pre></div></div>

<p>When it’s ready, the output will be:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">quickstart</span><span class="w">   </span><span class="nx">green</span><span class="w">    </span><span class="nx">1</span><span class="w">       </span><span class="nx">8.8.2</span><span class="w">     </span><span class="nx">4m9s</span><span class="w">
</span></code></pre></div></div>

<p>Check the pods:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kubectl</span><span class="w"> </span><span class="nx">get</span><span class="w"> </span><span class="nx">pod</span><span class="w"> </span><span class="nt">--selector</span><span class="o">=</span><span class="s1">'kibana.k8s.elastic.co/name=quickstart'</span><span class="w">
</span></code></pre></div></div>

<p>The output will be:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">NAME</span><span class="w">                             </span><span class="nx">READY</span><span class="w">   </span><span class="nx">STATUS</span><span class="w">    </span><span class="nx">RESTARTS</span><span class="w">   </span><span class="nx">AGE</span><span class="w">
</span><span class="n">quickstart-kb-66fb9f8b65-bsdp7</span><span class="w">   </span><span class="nx">1/1</span><span class="w">     </span><span class="nx">Running</span><span class="w">   </span><span class="nx">0</span><span class="w">          </span><span class="nx">5m20s</span><span class="w">
</span></code></pre></div></div>
<p>Now, check the service:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kubectl</span><span class="w"> </span><span class="nx">get</span><span class="w"> </span><span class="nx">service</span><span class="w"> </span><span class="nx">quickstart-kb-http</span><span class="w">
</span></code></pre></div></div>

<p>The output will be:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">NAME</span><span class="w">                 </span><span class="nx">TYPE</span><span class="w">        </span><span class="nx">CLUSTER-IP</span><span class="w">       </span><span class="nx">EXTERNAL-IP</span><span class="w">   </span><span class="nx">PORT</span><span class="p">(</span><span class="n">S</span><span class="p">)</span><span class="w">    </span><span class="n">AGE</span><span class="w">
</span><span class="nx">quickstart-kb-http</span><span class="w">   </span><span class="nx">ClusterIP</span><span class="w">   </span><span class="nx">10.111.153.143</span><span class="w">   </span><span class="err">&lt;</span><span class="nx">none</span><span class="err">&gt;</span><span class="w">        </span><span class="nx">5601/TCP</span><span class="w">   </span><span class="nx">5m40s</span><span class="w">
</span></code></pre></div></div>

<p>You can now forward the port</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w"> </span><span class="n">kubectl</span><span class="w"> </span><span class="nx">port-forward</span><span class="w"> </span><span class="nx">service/quickstart-kb-http</span><span class="w"> </span><span class="nx">5601</span><span class="w">
</span></code></pre></div></div>

<p>Get the password:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">kubectl</span><span class="w"> </span><span class="nx">get</span><span class="w"> </span><span class="nx">secret</span><span class="w"> </span><span class="nx">quickstart-es-elastic-user</span><span class="w"> </span><span class="nt">-o</span><span class="o">=</span><span class="n">jsonpath</span><span class="o">=</span><span class="s1">'{.data.elastic}'</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">%</span><span class="p">{[</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">UTF8.GetString</span><span class="p">([</span><span class="n">System.Convert</span><span class="p">]::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="bp">$_</span><span class="p">))};</span><span class="w">
</span></code></pre></div></div>
<p>It’s the same as the elasticsearch password.
Anyway, let’s connect to the web interface, open a browser and go to http://localhost:5601</p>

